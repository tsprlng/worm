<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_HADDOCK prune #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">{-|
Module: Worm
Description: Module for whimsically illustrating progress in a terminal with an animated worm.

This module is a library to maybe keep command-line tool users slightly happier, by whimsically illustrating progress in slow-running parallel processes with a mildly entertaining animated worm that crawls slowly from left to right and back again, while displaying textual progress from flexible sources of input.
-}</span><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Worm</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forkIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isEmptyMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putMVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">swapMVar</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">forM_</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hPutStr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stderr</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><a name="wormWidth"><a href="Worm.html#wormWidth"><span class="hs-identifier">wormWidth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">46</span><span>
</span><a name="line-19"></a><a name="wormFrameDelayMillis"><a href="Worm.html#wormFrameDelayMillis"><span class="hs-identifier">wormFrameDelayMillis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">230</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">-- * Showing Progress</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-comment">-- | The 'Progress' type is a general wrapper for &quot;Control.Concurrent.MVar&quot;-ish things we can read and show next to the animation, while another (worker) thread updates them.</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   To add another form of showable progress information, declare a new type which implements 'Progress_', and a constructor (like 'rawProgress') to wrap that type in 'Progress'.</span><span>
</span><a name="line-26"></a><span class="hs-keyword">data</span><span> </span><a name="Progress"><a href="Worm.html#Progress"><span class="hs-identifier">Progress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679012409"><a href="#local-6989586621679012409"><span class="hs-identifier">p</span></a></a><span class="hs-operator">.</span><span> </span><a href="Worm.html#Progress_"><span class="hs-identifier hs-type">Progress_</span></a><span> </span><a href="#local-6989586621679012409"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="Progress"><a href="Worm.html#Progress"><span class="hs-identifier">Progress</span></a></a><span> </span><a href="#local-6989586621679012409"><span class="hs-identifier hs-type">p</span></a><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-comment">-- | Class for formattable progress information types.</span><span>
</span><a name="line-29"></a><span class="hs-keyword">class</span><span> </span><a name="Progress_"><a href="Worm.html#Progress_"><span class="hs-identifier">Progress_</span></a></a><span> </span><a name="local-6989586621679012408"><a href="#local-6989586621679012408"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-comment">-- | A function that should (quickly) produce formatted progress information, for example by reading it from a wrapped 'Control.Concurrent.MVar.MVar'.</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-identifier">formatProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679012408"><span class="hs-identifier hs-type">p</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">instance</span><span> </span><a href="Worm.html#Progress_"><span class="hs-identifier hs-type">Progress_</span></a><span> </span><a href="Worm.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>  </span><a name="local-8214565720323786815"><a href="Worm.html#formatProgress"><span class="hs-identifier">formatProgress</span></a></a><span> </span><span class="hs-special">(</span><a href="Worm.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><a name="local-6989586621679020065"><a href="#local-6989586621679020065"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Worm.html#formatProgress"><span class="hs-identifier hs-var">formatProgress</span></a><span> </span><a href="#local-6989586621679020065"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">newtype</span><span> </span><a name="RawProgress"><a href="Worm.html#RawProgress"><span class="hs-identifier">RawProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RawProgress"><a href="Worm.html#RawProgress"><span class="hs-identifier">RawProgress</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">instance</span><span> </span><a href="Worm.html#Progress_"><span class="hs-identifier hs-type">Progress_</span></a><span> </span><a href="Worm.html#RawProgress"><span class="hs-identifier hs-type">RawProgress</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>  </span><a name="local-8214565720323786815"><a href="Worm.html#formatProgress"><span class="hs-identifier">formatProgress</span></a></a><span> </span><span class="hs-special">(</span><a href="Worm.html#RawProgress"><span class="hs-identifier hs-var">RawProgress</span></a><span> </span><a name="local-6989586621679020064"><a href="#local-6989586621679020064"><span class="hs-identifier">mV</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679020064"><span class="hs-identifier hs-var">mV</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-- | Displays (in brackets) a 'Control.Concurrent.MVar.MVar String' that you're free to update any way you choose.</span><span>
</span><a name="line-41"></a><span class="hs-identifier">rawProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Worm.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>
</span><a name="line-42"></a><a name="rawProgress"><a href="Worm.html#rawProgress"><span class="hs-identifier">rawProgress</span></a></a><span> </span><a name="local-6989586621679012410"><a href="#local-6989586621679012410"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Worm.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Worm.html#RawProgress"><span class="hs-identifier hs-var">RawProgress</span></a><span> </span><a href="#local-6989586621679012410"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">newtype</span><span> </span><a name="CollectingProgress"><a href="Worm.html#CollectingProgress"><span class="hs-identifier">CollectingProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CollectingProgress"><a href="Worm.html#CollectingProgress"><span class="hs-identifier">CollectingProgress</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">instance</span><span> </span><a href="Worm.html#Progress_"><span class="hs-identifier hs-type">Progress_</span></a><span> </span><a href="Worm.html#CollectingProgress"><span class="hs-identifier hs-type">CollectingProgress</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-46"></a><span>  </span><a name="local-8214565720323786815"><a href="Worm.html#formatProgress"><span class="hs-identifier">formatProgress</span></a></a><span> </span><span class="hs-special">(</span><a href="Worm.html#CollectingProgress"><span class="hs-identifier hs-var">CollectingProgress</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679020060"><a href="#local-6989586621679020060"><span class="hs-identifier">done</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679020061"><a href="#local-6989586621679020061"><span class="hs-identifier">total</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-47"></a><span>    </span><a name="local-6989586621679020062"><a href="#local-6989586621679020062"><span class="hs-identifier">done'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679020060"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-48"></a><span>    </span><a name="local-6989586621679020063"><a href="#local-6989586621679020063"><span class="hs-identifier">total'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679020061"><span class="hs-identifier hs-var">total</span></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679020062"><span class="hs-identifier hs-var">done'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679020063"><span class="hs-identifier hs-var">total'</span></a><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- | Displays as (43/200), where either side of the fraction-wall can be independently updated.</span><span>
</span><a name="line-52"></a><span class="hs-identifier">collectingProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Worm.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span>
</span><a name="line-53"></a><a name="collectingProgress"><a href="Worm.html#collectingProgress"><span class="hs-identifier">collectingProgress</span></a></a><span> </span><a name="local-6989586621679012411"><a href="#local-6989586621679012411"><span class="hs-identifier">done</span></a></a><span> </span><a name="local-6989586621679012412"><a href="#local-6989586621679012412"><span class="hs-identifier">total</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Worm.html#Progress"><span class="hs-identifier hs-var">Progress</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Worm.html#CollectingProgress"><span class="hs-identifier hs-var">CollectingProgress</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679012411"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679012412"><span class="hs-identifier hs-var">total</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- * Performing Animation</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-identifier">_wormAnimationFrames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- finite list of frames</span><span>
</span><a name="line-59"></a><a name="_wormAnimationFrames"><a href="Worm.html#_wormAnimationFrames"><span class="hs-identifier">_wormAnimationFrames</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679013575"><a href="#local-6989586621679013575"><span class="hs-identifier">indent</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679013575"><span class="hs-identifier hs-var">indent</span></a><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679012413"><span class="hs-identifier hs-var">wormStates</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-glyph">..</span><a href="Worm.html#wormWidth"><span class="hs-identifier hs-var">wormWidth</span></a><span class="hs-special">]</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="Worm.html#wormWidth"><span class="hs-identifier hs-var">wormWidth</span></a><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679012414"><span class="hs-identifier hs-var">turnAround</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679013761"><a href="#local-6989586621679013761"><span class="hs-identifier">indent</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679013761"><span class="hs-identifier hs-var">indent</span></a><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679012415"><span class="hs-identifier hs-var">wormStates2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="Worm.html#wormWidth"><span class="hs-identifier hs-var">wormWidth</span></a><span class="hs-special">,</span><span class="hs-special">(</span><a href="Worm.html#wormWidth"><span class="hs-identifier hs-var">wormWidth</span></a><span class="hs-glyph">-</span><span class="hs-number">2</span><span class="hs-special">)</span><span class="hs-glyph">..</span><span class="hs-number">0</span><span class="hs-special">]</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679012414"><span class="hs-identifier hs-var">turnAround</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-65"></a><span>    </span><a name="local-6989586621679012413"><a href="#local-6989586621679012413"><span class="hs-identifier">wormStates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;______,  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; __~__,  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;  _/\\_,  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;  __~__,  &quot;</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>    </span><a name="local-6989586621679012414"><a href="#local-6989586621679012414"><span class="hs-identifier">turnAround</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;  __~_,   &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;    _~,   &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;   ,_     &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;  ,~~_    &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;  ,__~_   &quot;</span><span class="hs-special">]</span><span>
</span><a name="line-67"></a><span>    </span><a name="local-6989586621679012415"><a href="#local-6989586621679012415"><span class="hs-identifier">wormStates2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot; ,______  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; ,__~__  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot; ,_/\\_  &quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;,__~__  &quot;</span><span class="hs-special">]</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | Action you can invoke to atomically stop/erase the worm before outputting real information, so your output goes unmangled.</span><span>
</span><a name="line-70"></a><span class="hs-keyword">type</span><span> </span><a name="Canceller"><a href="Worm.html#Canceller"><span class="hs-identifier">Canceller</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-- | Starts worm animation with given progress information; gives you a 'Canceller' to invoke when finished.</span><span>
</span><a name="line-73"></a><span class="hs-identifier">wormProgress</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Worm.html#Progress"><span class="hs-identifier hs-type">Progress</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Worm.html#Canceller"><span class="hs-identifier hs-type">Canceller</span></a><span>
</span><a name="line-74"></a><a name="wormProgress"><a href="Worm.html#wormProgress"><span class="hs-identifier">wormProgress</span></a></a><span> </span><a name="local-6989586621679013836"><a href="#local-6989586621679013836"><span class="hs-identifier">progress</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>  </span><a name="local-6989586621679018416"><a href="#local-6989586621679018416"><span class="hs-identifier">shouldStop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-76"></a><span>  </span><a name="local-6989586621679018417"><a href="#local-6989586621679018417"><span class="hs-identifier">stopped</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-identifier hs-var">forkIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679013837"><span class="hs-identifier hs-var">_showWorm</span></a><span> </span><a href="#local-6989586621679018416"><span class="hs-identifier hs-var">shouldStop</span></a><span> </span><a href="#local-6989586621679018417"><span class="hs-identifier hs-var">stopped</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cycle</span><span> </span><a href="Worm.html#_wormAnimationFrames"><span class="hs-identifier hs-var">_wormAnimationFrames</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- infinite list of frames</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679018416"><span class="hs-identifier hs-var">shouldStop</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621679018417"><span class="hs-identifier hs-var">stopped</span></a><span> </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-83"></a><span>    </span><a name="local-6989586621679013837"><a href="#local-6989586621679013837"><span class="hs-identifier">_showWorm</span></a></a><span> </span><a name="local-6989586621679013838"><a href="#local-6989586621679013838"><span class="hs-identifier">shouldStop</span></a></a><span> </span><a name="local-6989586621679013839"><a href="#local-6989586621679013839"><span class="hs-identifier">stopped</span></a></a><span> </span><a name="local-6989586621679013840"><a href="#local-6989586621679013840"><span class="hs-identifier">prevLen</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679013841"><a href="#local-6989586621679013841"><span class="hs-identifier">worm</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679013842"><a href="#local-6989586621679013842"><span class="hs-identifier">nextWorms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- pick first frame off the list and draw it</span><span>
</span><a name="line-84"></a><span>      </span><a name="local-6989586621679017395"><a href="#local-6989586621679017395"><span class="hs-identifier">willStop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">isEmptyMVar</span><span> </span><a href="#local-6989586621679013838"><span class="hs-identifier hs-var">shouldStop</span></a><span>
</span><a name="line-85"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679017395"><span class="hs-identifier hs-var">willStop</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>        </span><span class="hs-identifier hs-var">hPutStr</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;\r&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679013840"><span class="hs-identifier hs-var">prevLen</span></a><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\r\n&quot;</span><span>  </span><span class="hs-comment">-- TODO clear line with terminfo</span><span>
</span><a name="line-87"></a><span>        </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621679013839"><span class="hs-identifier hs-var">stopped</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621679017395"><span class="hs-identifier hs-var">willStop</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-89"></a><span>        </span><a name="local-6989586621679018221"><a href="#local-6989586621679018221"><span class="hs-identifier">progressChunks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Worm.html#formatProgress"><span class="hs-identifier hs-var">formatProgress</span></a><span> </span><a href="#local-6989586621679013836"><span class="hs-identifier hs-var">progress</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679018222"><a href="#local-6989586621679018222"><span class="hs-identifier">lineToDraw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679013841"><span class="hs-identifier hs-var">worm</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot; &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-string">&quot;(&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;)&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679018221"><span class="hs-identifier hs-var">progressChunks</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679018366"><a href="#local-6989586621679018366"><span class="hs-identifier">lengthDiff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679013840"><span class="hs-identifier hs-var">prevLen</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679018222"><span class="hs-identifier hs-var">lineToDraw</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-identifier hs-var">hPutStr</span><span> </span><span class="hs-identifier hs-var">stderr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;\r&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679018222"><span class="hs-identifier hs-var">lineToDraw</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679018366"><span class="hs-identifier hs-var">lengthDiff</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679018366"><span class="hs-identifier hs-var">lengthDiff</span></a><span> </span><span class="hs-char">'\b'</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Worm.html#wormFrameDelayMillis"><span class="hs-identifier hs-var">wormFrameDelayMillis</span></a><span class="hs-operator hs-var">*</span><span class="hs-number">1000</span><span>
</span><a name="line-94"></a><span>        </span><a href="#local-6989586621679013837"><span class="hs-identifier hs-var">_showWorm</span></a><span> </span><a href="#local-6989586621679013838"><span class="hs-identifier hs-var">shouldStop</span></a><span> </span><a href="#local-6989586621679013839"><span class="hs-identifier hs-var">stopped</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679018222"><span class="hs-identifier hs-var">lineToDraw</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679013842"><span class="hs-identifier hs-var">nextWorms</span></a><span>  </span><span class="hs-comment">-- draw next (and in turn, all remaining) frames</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-comment">-- | An example of basic usage.</span><span>
</span><a name="line-98"></a><a name="main"><a href="Worm.html#main"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>  </span><a name="local-6989586621679018920"><a href="#local-6989586621679018920"><span class="hs-identifier">progress</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-string">&quot;loading...&quot;</span><span>  </span><span class="hs-comment">-- set up progress variable to report to worm-drawing thread</span><span>
</span><a name="line-100"></a><span>  </span><a name="local-6989586621679018921"><a href="#local-6989586621679018921"><span class="hs-identifier">stopWorm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Worm.html#wormProgress"><span class="hs-identifier hs-var">wormProgress</span></a><span> </span><span class="hs-special">[</span><a href="Worm.html#rawProgress"><span class="hs-identifier hs-var">rawProgress</span></a><span> </span><a href="#local-6989586621679018920"><span class="hs-identifier hs-var">progress</span></a><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-number">300</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679018922"><a href="#local-6989586621679018922"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- simulate long process</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679018923"><a href="#local-6989586621679018923"><span class="hs-identifier">paddedPercent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">floor</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679018922"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">/</span><span class="hs-number">3.0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-char">' '</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-identifier hs-var">swapMVar</span><span> </span><a href="#local-6989586621679018920"><span class="hs-identifier hs-var">progress</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;loading (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679018923"><span class="hs-identifier hs-var">paddedPercent</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;%)...&quot;</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-number">80</span><span class="hs-operator hs-var">*</span><span class="hs-number">1000</span><span>
</span><a name="line-105"></a><span>  </span><a href="#local-6989586621679018921"><span class="hs-identifier hs-var">stopWorm</span></a><span>
</span><a name="line-106"></a></pre></body></html>